### SILVERSTRIPE START ###

# Deny access to templates (but allow from localhost)
<Files *.ss>
    Order deny,allow
    Deny from all
    Allow from 127.0.0.1
</Files>

# Deny access to IIS configuration
<Files web.config>
    Order deny,allow
    Deny from all
</Files>

# Deny access to YAML configuration files which might include sensitive information
<Files ~ "\.ya?ml$">
    Order allow,deny
    Deny from all
</Files>

# Route errors to static pages automatically generated by SilverStripe
ErrorDocument 404 /assets/error-404.html
ErrorDocument 500 /assets/error-500.html

<IfModule mod_rewrite.c>

    # Turn off index.php handling requests to the homepage fixes issue in apache >=2.4
    <IfModule mod_dir.c>
        DirectoryIndex disabled
        DirectorySlash On
    </IfModule>

    SetEnv HTTP_MOD_REWRITE On
    RewriteEngine On

    # Enable HTTP Basic authentication workaround for PHP running in CGI mode
    RewriteRule .* - [E=HTTP_AUTHORIZATION:%{HTTP:Authorization}]

    # Deny access to potentially sensitive files and folders
    RewriteRule ^vendor(/|$) - [F,L,NC]
    RewriteRule ^\.env - [F,L,NC]
    RewriteRule silverstripe-cache(/|$) - [F,L,NC]
    RewriteRule composer\.(json|lock) - [F,L,NC]
    RewriteRule (error|silverstripe|debug)\.log - [F,L,NC]

    # Process through SilverStripe if no file with the requested name exists.
    # Pass through the original path as a query parameter, and retain the existing parameters.
    # Try finding framework in the vendor folder first
    RewriteCond %{REQUEST_URI} ^(.*)$
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteRule .* index.php
</IfModule>
<IfModule mod_headers.c>

    # HTTP Headers for improved security
    Header set X-XSS-Protection "0; mode=block"
    Header set X-Content-Type-Options nosniff
    Header set Referrer-Policy no-referrer
    Header set Feature-Policy "camera 'none'; microphone 'none'; geolocation 'none'"
    Header set X-Frame-Options SAMEORIGIN
    # Don't set HSTS on local as some browsers prevent access when using self-signed TLS certs
    SetEnvIf HOST "\.(d|dev|local|localhost|site|test|vagrant)$" IS_DEV
    Header set Strict-Transport-Security "max-age=63072000; includeSubDomains" env=!IS_DEV
    Header set Content-Security-Policy "base-uri 'self'; default-src 'self'; child-src 'self' blob:; connect-src 'self' gus-quarantine-gus-277997488379.s3.amazonaws.com gus-quarantine-gus-728315971801.s3.amazonaws.com gus-quarantine-gus-703206946886.s3.amazonaws.com https://search1.ent.ap-southeast-2.aws.found.io https://submissions-277997488379-submissions-quarantine.s3.ap-southeast-2.amazonaws.com https://submissions-310637455872-submissions-quarantine.s3.ap-southeast-2.amazonaws.com https://submissions-test-nzqa.s3.ap-southeast-2.amazonaws.com https://submissions-728315971801-submissions-quarantine.s3.ap-southeast-2.amazonaws.com https://submissions-test-nzqa.s3.ap-southeast-2.amazonaws.com https://submissions-703206946886-submissions-quarantine.s3.ap-southeast-2.amazonaws.com https://submissions-test-nzqa.s3.ap-southeast-2.amazonaws.com https://submissions-211041981825-submissions-quarantine.s3.ap-southeast-2.amazonaws.com https://nzqa-submissions-repository-prod.s3.ap-southeast-2.amazonaws.com https://nzqa-submissions-repository-pp2.s3.ap-southeast-2.amazonaws.com https://nzqa-submissions-repository-test01.s3.ap-southeast-2.amazonaws.com https://nzqa-submissions-repository-dev.s3.ap-southeast-2.amazonaws.com https://*.google-analytics.com *.google-analytics.com https://*.analytics.google.com https://analytics.google.com https://www.googletagmanager.com *.googletagmanager.com https://www.google.com https://www.google.co.nz www.google.co.ck https://*.doubleclick.net https://translate.googleapis.com; font-src 'self'; form-action 'self'; frame-ancestors 'self'; frame-src 'self' https://*.youtube.com *.youtube.com https://*.vimeo.com *.vimeo.com https://*.googletagmanager.com; img-src 'self' *.google-analytics.com googleads.g.doubleclick.net www.google.com www.google.co.nz www.google.co.ck www.google-analytics.com *.googletagmanager.com translate.googleapis.com blob: data:; media-src https://*.youtube.com *.youtube.com https://*.vimeo.com *.vimeo.com; object-src 'none'; script-src 'self' https://ssl.google-analytics.com https://www.googleadservices.com https://googleads.g.doubleclick.net https://www.google.com https://www.google-analytics.com www.google-analytics.com https://www.youtube.com www.youtube.com https://s.ytimg.com s.ytimg.com https://www.google-analytics.com https://*.googletagmanager.com 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; report-uri https://report-to-api.raygun.com/reports-csp?apikey=bPmnJG1LEx28GNqDIEpg; upgrade-insecure-requests" env=!IS_DEV

</IfModule>
### SILVERSTRIPE END ###
